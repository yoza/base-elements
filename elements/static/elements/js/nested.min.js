var Nested=new Class({getOptions:function(){return{childTag:"LI",ghost:true,childStep:30,handleClass:null,onStart:Class.empty,onComplete:Class.empty,collapse:false,collapseClass:"nCollapse",expandKey:"shift",lock:null,lockClass:"unlocked"}},initialize:function(b,a){this.setOptions(this.getOptions(),a);if(!this.options.expandKey.match(/^(control|shift)$/)){this.options.expandKey="shift"}this.list=$(b);this.options.parentTag=this.list.nodeName;this.bound={};this.bound.start=this.start.bindWithEvent(this);this.list.addEvent("mousedown",this.bound.start);if(this.options.collapse){this.bound.collapse=this.collapse.bindWithEvent(this);this.list.addEvent("click",this.bound.collapse)}if(this.options.initialize){this.options.initialize.call(this)}},start:function(b){var a=$(b.target);if(this.options.handleClass){while(a.nodeName!=this.options.childTag&&!a.hasClass(this.options.handleClass)&&a!=this.list){a=a.getParent()}if(!a.hasClass(this.options.handleClass)){return true}}while(a.nodeName!=this.options.childTag&&a!=this.list){a=a.parentNode}if(a.nodeName!=this.options.childTag){return true}a=$(a);if(this.options.lock=="class"&&!a.hasClass(this.options.lockClass)){return}if(this.options.ghost){this.ghost=a.clone().setStyles({"list-style-type":"none",opacity:0.5,position:"absolute",visibility:"hidden",top:b.page.y+"px",left:(b.page.x+10)+"px"}).injectInside(document.body)}a.depth=this.getDepth(a);a.moved=false;this.bound.movement=this.movement.bindWithEvent(this,a);this.bound.end=this.end.bind(this,a);this.list.removeEvent("mousedown",this.bound.start);this.list.addEvent("mousedown",this.bound.end);this.list.addEvent("mousemove",this.bound.movement);document.addEvent("mouseup",this.bound.end);if(window.ie){this.bound.stop=this.stop.bindWithEvent(this);$(document.body).addEvent("drag",this.bound.stop).addEvent("selectstart",this.bound.stop)}this.fireEvent("onStart",a);b.stop()},collapse:function(c){var b=$(c.target);if(this.options.handleClass){while(b.nodeName!=this.options.childTag&&!b.hasClass(this.options.handleClass)&&b!=this.list){b=b.getParent()}if(!b.hasClass(this.options.handleClass)){return true}}while(b.nodeName!=this.options.childTag&&b!=this.list){b=b.parentNode}if(b==this.list){return}b=$(b);if(!b.moved){var a=$E(this.options.parentTag,b);if(a){if(a.getStyle("display")=="none"){a.setStyle("display","block");b.removeClass(this.options.collapseClass)}else{a.setStyle("display","none");b.addClass(this.options.collapseClass)}}}c.stop()},stop:function(a){a.stop();return false},getDepth:function(b,c){var a=(c)?1:0;while(b!=this.list){if(b.nodeName==this.options.parentTag){a+=1}b=b.parentNode}return a},movement:function(a,d){var e,i,b,j;var k,f,g,c;var h=false;if(this.options.ghost&&d.moved){this.ghost.setStyles({position:"absolute",visibility:"visible",top:a.page.y+"px",left:(a.page.x+10)+"px"})}i=a.target;while(i.nodeName!=this.options.childTag&&i!=this.list){i=i.parentNode}if(i==this.list){return}if(a[this.options.expandKey]&&i!=d&&i.hasClass(this.options.collapseClass)){b=$E(this.options.parentTag,i);i.removeClass(this.options.collapseClass);b.setStyle("display","block")}orig=i;if(d!=i){j=$ES(this.options.childTag,i);j.each(function(l){if(a.page.y>l.getTop()&&l.offsetHeight>0){i=l}})}if(i.nodeName!=this.options.childTag){return}c=d.getParent();e=(a.page.y<d.getTop())?"up":"down";f="before";k=d;if(d!=i){b=i;while(b!=null&&b!=d){b=b.parentNode}if(b==d){return}if(e=="up"){f="before";k=i}else{sub=$E(this.options.childTag,i);if(sub&&sub.offsetHeight>0){f="before";k=sub}else{f="after";k=i}}}g=(f=="before")?k.getPrevious():k;if(g){f="after";k=g;b=$E(this.options.parentTag,k);while(b&&a.page.x>b.getLeft()&&b.offsetHeight>0){k=b.getLast();b=$E(this.options.parentTag,k)}if(!b&&a.page.x>k.getLeft()+this.options.childStep){f="inside"}}last=k.getParent().getLast();while(((f=="after"&&last==k)||last==d)&&k.getParent()!=this.list&&a.page.x<k.getLeft()){f="after";k=$(k.parentNode.parentNode);last=k.getParent().getLast()}h=false;if(f!=""){h+=(k==d);h+=(f=="after"&&k.getNext()==d);h+=(f=="before"&&k.getPrevious()==d);h+=(this.options.lock=="depth"&&d.depth!=this.getDepth(k,(f=="inside")));h+=(this.options.lock=="parent"&&(f=="inside"||k.parentNode!=d.parentNode));h+=(k.offsetHeight==0);sub=$E(this.options.parentTag,i);sub=(sub)?sub.getTop():0;sub=(sub>0)?sub-i.getTop():i.offsetHeight;h+=(a.page.y<(sub-d.offsetHeight)+i.getTop());if(!h){if(f=="inside"){k=new Element(this.options.parentTag).injectInside(k)}$(d).inject(k,f);d.moved=true;if(!c.getFirst()){c.remove()}}}a.stop()},detach:function(){this.list.removeEvent("mousedown",this.start.bindWithEvent(this));if(this.options.collapse){this.list.removeEvent("click",this.bound.collapse)}},serialize:function(c){var b=[];var a;if(!c){c=this.list}$$(c.childNodes).each(function(e,d){a=$E(this.options.parentTag.toLowerCase(),e);b[d]={id:e.id,children:(a)?this.serialize(a):[]}}.bind(this));return b},end:function(a){if(this.options.ghost){this.ghost.remove()}this.list.removeEvent("mousemove",this.bound.movement);document.removeEvent("mouseup",this.bound.end);this.list.removeEvent("mousedown",this.bound.end);this.list.addEvent("mousedown",this.bound.start);this.fireEvent("onComplete",a);if(window.ie){$(document.body).removeEvent("drag",this.bound.stop).removeEvent("selectstart",this.bound.stop)}}});if(window.ie){Element.NativeEvents.push("selectstart");Element.NativeEvents.push("drag")}Nested.implement(new Events);Nested.implement(new Options);